<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Video Marker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.3.2/three.js/build/ar-threex.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
            background: #000;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2;
            pointer-events: none;
        }
        #video-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80vw;
            max-width: 600px;
            height: auto;
            z-index: 3;
            display: none;
            border: 2px solid white;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="loading">Cargando cámara...</div>
    <video id="video-background" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <video id="video-overlay" src="assets/video1.mp4" loop playsinline muted></video>
    
    <script>
        const loading = document.getElementById('loading');
        const videoBg = document.getElementById('video-background');
        const videoOverlay = document.getElementById('video-overlay');
        const canvas = document.getElementById('canvas');
        
        let arToolkitSource, arToolkitContext;
        let scene, camera, renderer;
        let markerRoot, markerControls;
        let markerDetected = false;
        let animationId;

        // Primero obtener la cámara y mostrarla
        function getCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                loading.textContent = 'Tu navegador no soporta cámara';
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(function(stream) {
                console.log('✓ Cámara obtenida');
                videoBg.srcObject = stream;
                videoBg.style.display = 'block';
                
                videoBg.play().then(() => {
                    console.log('✓ Video de cámara reproduciendo');
                }).catch(err => {
                    console.error('Error al reproducir:', err);
                });
                
                videoBg.addEventListener('loadedmetadata', function() {
                    console.log('✓ Metadata cargado:', videoBg.videoWidth, 'x', videoBg.videoHeight);
                    loading.style.display = 'none';
                    
                    // Inicializar AR después de que la cámara esté lista
                    setTimeout(() => {
                        initAR();
                    }, 500);
                });
            })
            .catch(function(err) {
                console.error('✗ Error cámara:', err);
                loading.textContent = 'Error: ' + err.message;
            });
        }

        function initAR() {
            console.log('Inicializando AR...');
            
            // Verificar que THREEx esté disponible
            if (typeof THREEx === 'undefined') {
                console.error('THREEx no está disponible');
                return;
            }
            
            // Configurar canvas
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Inicializar Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000);
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0);
            
            // Inicializar AR.js
            try {
                arToolkitSource = new THREEx.ArToolkitSource({
                    sourceType: 'webcam',
                    sourceWidth: 1280,
                    sourceHeight: 720,
                    displayWidth: window.innerWidth,
                    displayHeight: window.innerHeight
                });
                
                arToolkitContext = new THREEx.ArToolkitContext({
                    cameraParametersUrl: 'https://cdn.jsdelivr.net/npm/ar.js@3.3.2/data/data/camera_para.dat',
                    detectionMode: 'mono',
                    maxDetectionRate: 30,
                    canvasWidth: 1280,
                    canvasHeight: 720
                });
                
                arToolkitSource.init(function() {
                    arToolkitSource.onResizeElement();
                    arToolkitSource.copyElementSizeTo(renderer.domElement);
                    
                    arToolkitContext.init(function() {
                        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                        console.log('✓ AR.js inicializado');
                        
                        // Crear marcador
                        markerRoot = new THREE.Group();
                        scene.add(markerRoot);
                        
                        markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                            type: 'pattern',
                            patternUrl: 'assets/marker1.patt',
                            changeMatrixMode: 'cameraTransformMatrix'
                        });
                        
                        markerControls.addEventListener('markerFound', function() {
                            if (!markerDetected) {
                                console.log('✓✓✓ MARCADOR DETECTADO ✓✓✓');
                                markerDetected = true;
                                videoOverlay.style.display = 'block';
                                videoOverlay.play().catch(err => console.error('Error:', err));
                            }
                        });
                        
                        markerControls.addEventListener('markerLost', function() {
                            if (markerDetected) {
                                console.log('Marcador perdido');
                                markerDetected = false;
                                videoOverlay.style.display = 'none';
                                videoOverlay.pause();
                            }
                        });
                        
                        // Configurar video para AR.js
                        arToolkitSource.domElement = videoBg;
                        
                        // Iniciar animación
                        animate();
                    });
                });
            } catch (err) {
                console.error('Error al inicializar AR.js:', err);
            }
        }
        
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            if (arToolkitSource && arToolkitSource.ready && arToolkitContext) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', function() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                if (arToolkitSource) {
                    arToolkitSource.onResizeElement();
                    arToolkitSource.copyElementSizeTo(renderer.domElement);
                }
            }
        });
        
        // Iniciar cuando se carga la página
        window.addEventListener('load', function() {
            getCamera();
        });
        
        // Limpiar
        window.addEventListener('beforeunload', function() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (videoBg.srcObject) {
                videoBg.srcObject.getTracks().forEach(track => track.stop());
            }
            videoOverlay.pause();
        });
    </script>
</body>
</html>
