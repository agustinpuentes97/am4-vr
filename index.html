<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Video Marker</title>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.3.2/three.js/build/ar-threex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2;
            pointer-events: none;
        }
        #video-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80vw;
            max-width: 600px;
            height: auto;
            z-index: 3;
            display: none;
            border: 2px solid white;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="loading">Cargando cámara...</div>
    <video id="video-background" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <video id="video-overlay" src="assets/video1.mp4" loop playsinline muted></video>
    
    <script>
        const loading = document.getElementById('loading');
        const videoBg = document.getElementById('video-background');
        const videoOverlay = document.getElementById('video-overlay');
        const canvas = document.getElementById('canvas');
        
        let arToolkitSource, arToolkitContext;
        let scene, camera, renderer;
        let markerRoot, markerControls;
        let markerDetected = false;

        function init() {
            // Configurar canvas
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Inicializar Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000);
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                alpha: true,
                antialias: true,
                premultipliedAlpha: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // Transparente
            
            // Inicializar AR.js
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
                sourceWidth: 1280,
                sourceHeight: 720,
                displayWidth: window.innerWidth,
                displayHeight: window.innerHeight
            });
            
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://cdn.jsdelivr.net/npm/ar.js@3.3.2/data/data/camera_para.dat',
                detectionMode: 'mono',
                maxDetectionRate: 30,
                canvasWidth: 1280,
                canvasHeight: 720
            });
            
            // Inicializar fuente
            arToolkitSource.init(function() {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
                
                // Inicializar contexto
                arToolkitContext.init(function() {
                    camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                });
            });
            
            // Crear grupo para el marcador
            markerRoot = new THREE.Group();
            scene.add(markerRoot);
            
            // Controles del marcador
            markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'pattern',
                patternUrl: 'assets/marker1.patt',
                changeMatrixMode: 'cameraTransformMatrix'
            });
            
            // Eventos del marcador
            markerControls.addEventListener('markerFound', function() {
                if (!markerDetected) {
                    console.log('✓ Marcador detectado');
                    markerDetected = true;
                    videoOverlay.style.display = 'block';
                    videoOverlay.play().catch(err => console.error('Error:', err));
                }
            });
            
            markerControls.addEventListener('markerLost', function() {
                if (markerDetected) {
                    console.log('Marcador perdido');
                    markerDetected = false;
                    videoOverlay.style.display = 'none';
                    videoOverlay.pause();
                }
            });
            
            // Obtener acceso a la cámara
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(function(stream) {
                console.log('Cámara obtenida');
                videoBg.srcObject = stream;
                
                // Forzar reproducción
                videoBg.play().then(() => {
                    console.log('Video de cámara reproduciendo');
                }).catch(err => {
                    console.error('Error al reproducir video:', err);
                });
                
                videoBg.addEventListener('loadedmetadata', function() {
                    console.log('Metadata de cámara cargado:', videoBg.videoWidth, 'x', videoBg.videoHeight);
                    
                    // Asegurar que el video sea visible
                    videoBg.style.display = 'block';
                    
                    // Configurar AR.js
                    if (arToolkitSource) {
                        arToolkitSource.domElement = videoBg;
                    }
                    
                    loading.style.display = 'none';
                    animate();
                });
                
                // También verificar cuando esté listo
                videoBg.addEventListener('playing', function() {
                    console.log('Video de cámara está reproduciendo');
                    videoBg.style.display = 'block';
                });
                
                // Fallback: si después de 2 segundos no se ve, forzar visibilidad
                setTimeout(() => {
                    if (videoBg.videoWidth === 0) {
                        console.log('Video no tiene dimensiones, forzando visibilidad');
                        videoBg.style.display = 'block';
                    }
                }, 2000);
            })
            .catch(function(err) {
                console.error('Error cámara:', err);
                loading.textContent = 'Error al acceder a la cámara: ' + err.message;
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (arToolkitSource && arToolkitSource.ready && arToolkitContext) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (arToolkitSource) {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
            }
        });
        
        window.addEventListener('load', init);
        
        window.addEventListener('beforeunload', function() {
            if (videoBg.srcObject) {
                videoBg.srcObject.getTracks().forEach(track => track.stop());
            }
            videoOverlay.pause();
        });
    </script>
</body>
</html>
